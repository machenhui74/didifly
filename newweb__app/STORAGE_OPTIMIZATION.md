# ğŸ“¦ å­˜å‚¨ä¼˜åŒ–æŠ€æœ¯æ–‡æ¡£

*åˆ›å»ºæ—¥æœŸ: 2025å¹´5æœˆ26æ—¥*
*ç‰ˆæœ¬: v1.0*

---

## ğŸ¯ **æ¦‚è¿°**

æœ¬æ–‡æ¡£è¯¦ç»†è®°å½•äº†newweb__appé¡¹ç›®ä¸­è®­ç»ƒæ–¹æ¡ˆè‡ªåŠ¨æ¸…ç†åŠŸèƒ½çš„æŠ€æœ¯å®ç°ï¼Œè¯¥åŠŸèƒ½æ—¨åœ¨è§£å†³äº‘æœåŠ¡å™¨å­˜å‚¨ç©ºé—´ä¸è¶³çš„é—®é¢˜ï¼Œé€šè¿‡æ™ºèƒ½çš„æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå®ç°å­˜å‚¨ç©ºé—´çš„é«˜æ•ˆåˆ©ç”¨ã€‚

---

## ğŸ“Š **é—®é¢˜åˆ†æ**

### å­˜å‚¨ç©ºé—´å †ç§¯é—®é¢˜
- **é—®é¢˜ç°è±¡**ï¼šè®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶åœ¨ `data/student_training_plans/` ç›®å½•æŒç»­å †ç§¯
- **å½±å“èŒƒå›´**ï¼šæ‰€æœ‰è®­ç»ƒæ–¹æ¡ˆç”ŸæˆåŠŸèƒ½ï¼ˆæµ‹è¯„ç»“æœæ¨¡å¼ + ä¸“æ³¨åŠ›å¤‡è¯¾æ¨¡å¼ï¼‰
- **ä¸¥é‡ç¨‹åº¦**ï¼šé«˜ï¼ˆå¯èƒ½å¯¼è‡´äº‘æœåŠ¡å™¨å­˜å‚¨ç©ºé—´è€—å°½ï¼‰

### æ•°æ®é‡åˆ†æ
```
å•ä¸ªè®­ç»ƒæ–¹æ¡ˆå¤§å°ï¼š
â”œâ”€â”€ 12èŠ‚è¯¾ Ã— 7é¢˜ Ã— 2MB â‰ˆ 168MB
â”œâ”€â”€ æ¯æ—¥ç”Ÿæˆé‡ï¼š10ä¸ªæ–¹æ¡ˆ â‰ˆ 1.68GB
â”œâ”€â”€ æœˆç´¯ç§¯é‡ï¼š1.68GB Ã— 30å¤© â‰ˆ 50GB
â””â”€â”€ äº‘æœåŠ¡å™¨å®¹é‡ï¼šé€šå¸¸20-100GBï¼ˆå¾ˆå¿«è€—å°½ï¼‰
```

### å†…å­˜ä½¿ç”¨å¯¹æ¯”
| æ–¹æ¡ˆç±»å‹ | å³°å€¼å†…å­˜ä½¿ç”¨ | å¹¶å‘èƒ½åŠ›(2GBæœåŠ¡å™¨) | å­˜å‚¨ç©ºé—´å ç”¨ |
|---------|-------------|-------------------|-------------|
| **å½“å‰æ–¹æ¡ˆ** | ~30MB | 66ä¸ªå¹¶å‘ | ä¸´æ—¶å ç”¨ |
| çº¯å†…å­˜æ–¹æ¡ˆ | ~200MB | 10ä¸ªå¹¶å‘ | æ— å ç”¨ |
| åŸå§‹æ–¹æ¡ˆ | ~30MB | 66ä¸ªå¹¶å‘ | æ°¸ä¹…ç´¯ç§¯ |

---

## ğŸ”§ **æŠ€æœ¯å®ç°**

### æ ¸å¿ƒè®¾è®¡æ€è·¯
```python
# ä¼˜åŒ–å‰çš„å·¥ä½œæµç¨‹
ç”Ÿæˆæ–‡ä»¶åˆ°ç£ç›˜ â†’ åˆ›å»ºZIP â†’ å‘é€ä¸‹è½½ â†’ æ–‡ä»¶æ°¸ä¹…ä¿ç•™ âŒ

# ä¼˜åŒ–åçš„å·¥ä½œæµç¨‹  
ç”Ÿæˆæ–‡ä»¶åˆ°ç£ç›˜ â†’ åˆ›å»ºZIP â†’ ç«‹å³åˆ é™¤åŸæ–‡ä»¶ â†’ å‘é€ä¸‹è½½ âœ…
```

### å…³é”®ä»£ç å®ç°
```python
def _download_plan_helper(plan_type):
    """è®­ç»ƒè®¡åˆ’ä¸‹è½½çš„é€šç”¨è¾…åŠ©å‡½æ•° - æ”¯æŒè‡ªåŠ¨æ¸…ç†"""
    folder_path = None  # ç”¨äºè®°å½•éœ€è¦åˆ é™¤çš„æ–‡ä»¶å¤¹è·¯å¾„
    try:
        # è·å–é…ç½®å‚æ•°
        weeks = int(request.form.get('weeks', '1'))
        source_folder = current_app.config.get('SOURCE_FOLDER', './training_files')
        destination_folder = current_app.config.get('DESTINATION_FOLDER', './generated_plans')
        
        # æ ¹æ®æ¨¡å¼ç”Ÿæˆè®­ç»ƒæ–¹æ¡ˆ
        if plan_type == 'assessment':
            # æµ‹è¯„ç»“æœæ¨¡å¼é€»è¾‘
            results_data = session.get('results_data')
            # ... ç”Ÿæˆé€»è¾‘ ...
        else:
            # ä¸“æ³¨åŠ›å¤‡è¯¾æ¨¡å¼é€»è¾‘  
            # ... ç”Ÿæˆé€»è¾‘ ...
        
        # è®°å½•ç”Ÿæˆçš„æ–‡ä»¶å¤¹è·¯å¾„
        folder_path = os.path.join(destination_folder, folder_name)
        
        # åˆ›å»ºZIPæ–‡ä»¶åˆ°å†…å­˜
        memory_file = create_zip_from_folder(folder_path, destination_folder)
        
        # ğŸ”¥ å…³é”®ä¼˜åŒ–ï¼šåœ¨å‘é€æ–‡ä»¶å‰åˆ é™¤åŸå§‹æ–‡ä»¶å¤¹ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´
        try:
            if folder_path and os.path.exists(folder_path):
                shutil.rmtree(folder_path)
                current_app.logger.info(f"âœ… å·²åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹: {folder_path}")
        except Exception as delete_error:
            current_app.logger.warning(f"âš ï¸ åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹å¤±è´¥: {folder_path}, é”™è¯¯: {str(delete_error)}")
        
        # å‘é€ZIPæ–‡ä»¶ç»™ç”¨æˆ·ä¸‹è½½
        return send_file(
            memory_file,
            as_attachment=True,
            download_name=f"{name}â€”{weeks}å‘¨è®­ç»ƒæ–¹æ¡ˆ.zip",
            mimetype='application/zip'
        )
        
    except Exception as e:
        # ğŸ›¡ï¸ å¼‚å¸¸å®‰å…¨ï¼šå¦‚æœå‡ºé”™ä¸”æ–‡ä»¶å¤¹å·²ç”Ÿæˆï¼Œå°è¯•æ¸…ç†
        if folder_path and os.path.exists(folder_path):
            try:
                shutil.rmtree(folder_path)
                current_app.logger.info(f"ğŸ”§ é”™è¯¯å¤„ç†ï¼šå·²åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹: {folder_path}")
            except Exception as cleanup_error:
                current_app.logger.warning(f"âŒ é”™è¯¯å¤„ç†ï¼šåˆ é™¤æ–‡ä»¶å¤¹å¤±è´¥: {folder_path}")
        
        current_app.logger.error(f"è®­ç»ƒè®¡åˆ’ä¸‹è½½å¤±è´¥: {str(e)}")
        flash('è®­ç»ƒè®¡åˆ’ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚', 'error')
        return redirect(url_for('main.index'))
```

### ZIPæ–‡ä»¶åˆ›å»ºä¼˜åŒ–
```python
def create_zip_from_folder(folder_path, base_path):
    """åˆ›å»ºZIPæ–‡ä»¶åˆ°å†…å­˜ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨"""
    memory_file = BytesIO()
    
    with zipfile.ZipFile(memory_file, 'w', zipfile.ZIP_DEFLATED) as zipf:
        for root, dirs, files in os.walk(folder_path):
            for file in files:
                file_path = os.path.join(root, file)
                # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼Œä¿æŒæ–‡ä»¶å¤¹ç»“æ„
                arcname = os.path.relpath(file_path, base_path)
                zipf.write(file_path, arcname)
    
    memory_file.seek(0)
    return memory_file
```

---

## ğŸ“ˆ **æ€§èƒ½ä¼˜åŒ–æ•ˆæœ**

### å­˜å‚¨ç©ºé—´ä¼˜åŒ–
- **ç©ºé—´èŠ‚çœç‡**ï¼šæ¥è¿‘100%ï¼ˆä¸´æ—¶æ–‡ä»¶ç«‹å³åˆ é™¤ï¼‰
- **ç´¯ç§¯æ•ˆåº”**ï¼šé¿å…æœˆåº¦50GB+çš„å­˜å‚¨å †ç§¯
- **æœåŠ¡å™¨ç¨³å®šæ€§**ï¼šæ¶ˆé™¤å› å­˜å‚¨ç©ºé—´ä¸è¶³å¯¼è‡´çš„ç³»ç»Ÿå´©æºƒé£é™©

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–
- **å³°å€¼å†…å­˜**ï¼š30MBï¼ˆç›¸æ¯”çº¯å†…å­˜æ–¹æ¡ˆèŠ‚çœ85%ï¼‰
- **å¹¶å‘å¤„ç†èƒ½åŠ›**ï¼š2GBæœåŠ¡å™¨æ”¯æŒ66ä¸ªå¹¶å‘ä¸‹è½½
- **å†…å­˜ç¨³å®šæ€§**ï¼šé¿å…å¤§æ–‡ä»¶å¯¼è‡´çš„å†…å­˜æº¢å‡º

### ç³»ç»Ÿå“åº”æ€§èƒ½
- **æ–‡ä»¶ç”Ÿæˆé€Ÿåº¦**ï¼šæ— å˜åŒ–ï¼ˆä»ç„¶ä½¿ç”¨ç£ç›˜ç”Ÿæˆï¼‰
- **ä¸‹è½½å“åº”æ—¶é—´**ï¼šæ— å˜åŒ–ï¼ˆZIPæ–‡ä»¶å¤§å°ç›¸åŒï¼‰
- **æ¸…ç†æ“ä½œè€—æ—¶**ï¼š<100msï¼ˆå¯¹ç”¨æˆ·ä½“éªŒæ— å½±å“ï¼‰

---

## ğŸ›¡ï¸ **å®‰å…¨æ€§å’Œå¯é æ€§**

### å¼‚å¸¸å®‰å…¨æœºåˆ¶
```python
# 1. æ­£å¸¸æµç¨‹å®‰å…¨
ç”Ÿæˆæ–‡ä»¶ â†’ åˆ›å»ºZIP â†’ åˆ é™¤åŸæ–‡ä»¶ â†’ å‘é€ä¸‹è½½

# 2. å¼‚å¸¸æµç¨‹å®‰å…¨  
ç”Ÿæˆæ–‡ä»¶ â†’ åˆ›å»ºZIPå¤±è´¥ â†’ åˆ é™¤åŸæ–‡ä»¶ â†’ è¿”å›é”™è¯¯

# 3. æç«¯å¼‚å¸¸å®‰å…¨
ç”Ÿæˆæ–‡ä»¶ â†’ ç³»ç»Ÿå¼‚å¸¸ â†’ finallyå—åˆ é™¤ â†’ èµ„æºä¸æ³„éœ²
```

### æ—¥å¿—ç›‘æ§ä½“ç³»
```python
# æˆåŠŸæ“ä½œæ—¥å¿—
current_app.logger.info(f"âœ… å·²åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹: {folder_path}")

# è­¦å‘Šæ—¥å¿—ï¼ˆåˆ é™¤å¤±è´¥ä½†ä¸å½±å“åŠŸèƒ½ï¼‰
current_app.logger.warning(f"âš ï¸ åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹å¤±è´¥: {folder_path}, é”™è¯¯: {str(delete_error)}")

# é”™è¯¯å¤„ç†æ—¥å¿—
current_app.logger.info(f"ğŸ”§ é”™è¯¯å¤„ç†ï¼šå·²åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹: {folder_path}")

# ç³»ç»Ÿé”™è¯¯æ—¥å¿—
current_app.logger.error(f"âŒ è®­ç»ƒè®¡åˆ’ä¸‹è½½å¤±è´¥: {str(e)}")
```

### æ•°æ®å®Œæ•´æ€§ä¿è¯
- **ç”¨æˆ·æ•°æ®**ï¼šZIPæ–‡ä»¶å®Œæ•´æ€§ä¸å—å½±å“
- **ç³»ç»Ÿæ•°æ®**ï¼šæ ¸å¿ƒä¸šåŠ¡æ•°æ®ä¸å—æ¸…ç†å½±å“
- **é…ç½®æ•°æ®**ï¼šæ¸…ç†æ“ä½œä¸æ¶‰åŠé…ç½®æ–‡ä»¶ä¿®æ”¹

---

## ğŸ” **ç›‘æ§å’Œç»´æŠ¤**

### å…³é”®ç›‘æ§æŒ‡æ ‡
```python
# 1. å­˜å‚¨ç©ºé—´ç›‘æ§
disk_usage = shutil.disk_usage(destination_folder)
free_space_gb = disk_usage.free / (1024**3)

# 2. æ¸…ç†æ“ä½œç›‘æ§
cleanup_success_rate = successful_cleanups / total_cleanups * 100

# 3. å†…å­˜ä½¿ç”¨ç›‘æ§  
memory_usage = psutil.Process().memory_info().rss / (1024**2)  # MB

# 4. å¹¶å‘å¤„ç†ç›‘æ§
concurrent_downloads = len(active_download_sessions)
```

### æ—¥å¿—åˆ†æè„šæœ¬
```bash
# æŸ¥çœ‹æ¸…ç†æ“ä½œç»Ÿè®¡
grep "å·²åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹" logs/app.log | wc -l

# æŸ¥çœ‹æ¸…ç†å¤±è´¥æƒ…å†µ
grep "åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹å¤±è´¥" logs/app.log

# æŸ¥çœ‹å­˜å‚¨ç©ºé—´è¶‹åŠ¿
df -h data/student_training_plans/
```

### ç»´æŠ¤å»ºè®®
1. **å®šæœŸæ£€æŸ¥**ï¼šæ¯å‘¨æ£€æŸ¥å­˜å‚¨ç©ºé—´ä½¿ç”¨æƒ…å†µ
2. **æ—¥å¿—å®¡æŸ¥**ï¼šæ¯æœˆå®¡æŸ¥æ¸…ç†æ“ä½œæ—¥å¿—
3. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§å†…å­˜ä½¿ç”¨å’Œå¹¶å‘å¤„ç†èƒ½åŠ›
4. **å¤‡ä»½ç­–ç•¥**ï¼šé‡è¦è®­ç»ƒæ–¹æ¡ˆå¯è€ƒè™‘å¼‚æ­¥å¤‡ä»½åˆ°å…¶ä»–å­˜å‚¨

---

## ğŸš€ **æ‰©å±•ä¼˜åŒ–æ–¹æ¡ˆ**

### è¿›ä¸€æ­¥ä¼˜åŒ–æ–¹å‘
1. **å¼‚æ­¥æ¸…ç†**ï¼šä½¿ç”¨åå°ä»»åŠ¡è¿›è¡Œæ–‡ä»¶æ¸…ç†
2. **åˆ†çº§å­˜å‚¨**ï¼šé‡è¦æ–‡ä»¶çŸ­æœŸä¿ç•™ï¼Œæ™®é€šæ–‡ä»¶ç«‹å³æ¸…ç†
3. **å‹ç¼©ä¼˜åŒ–**ï¼šä½¿ç”¨æ›´é«˜æ•ˆçš„å‹ç¼©ç®—æ³•å‡å°‘ZIPæ–‡ä»¶å¤§å°
4. **ç¼“å­˜æœºåˆ¶**ï¼šç›¸åŒå‚æ•°çš„è®­ç»ƒæ–¹æ¡ˆä½¿ç”¨ç¼“å­˜é¿å…é‡å¤ç”Ÿæˆ

### é…ç½®åŒ–æ¸…ç†ç­–ç•¥
```python
# config.py ä¸­çš„æ¸…ç†é…ç½®
CLEANUP_STRATEGY = {
    'immediate': True,           # ç«‹å³æ¸…ç†
    'retention_hours': 0,        # ä¿ç•™æ—¶é—´ï¼ˆå°æ—¶ï¼‰
    'max_folder_size_mb': 500,   # å•ä¸ªæ–‡ä»¶å¤¹æœ€å¤§å¤§å°
    'max_total_size_gb': 2,      # æ€»å­˜å‚¨é™åˆ¶
    'cleanup_on_error': True     # é”™è¯¯æ—¶æ˜¯å¦æ¸…ç†
}
```

### äº‘å­˜å‚¨é›†æˆ
```python
# å¯é€‰ï¼šé›†æˆäº‘å­˜å‚¨æœåŠ¡
def upload_to_cloud_storage(file_path, cloud_path):
    """ä¸Šä¼ åˆ°äº‘å­˜å‚¨å¹¶åˆ é™¤æœ¬åœ°æ–‡ä»¶"""
    # ä¸Šä¼ åˆ°é˜¿é‡Œäº‘OSS/è…¾è®¯äº‘COSç­‰
    # æˆåŠŸååˆ é™¤æœ¬åœ°æ–‡ä»¶
    pass
```

---

## ğŸ“‹ **éƒ¨ç½²æ£€æŸ¥æ¸…å•**

### éƒ¨ç½²å‰æ£€æŸ¥
- [ ] ç¡®è®¤ `shutil` æ¨¡å—å·²å¯¼å…¥
- [ ] éªŒè¯æ–‡ä»¶å¤¹è·¯å¾„é…ç½®æ­£ç¡®
- [ ] æµ‹è¯•ZIPæ–‡ä»¶åˆ›å»ºåŠŸèƒ½
- [ ] æ£€æŸ¥æ—¥å¿—è®°å½•é…ç½®

### éƒ¨ç½²åéªŒè¯
- [ ] ç”Ÿæˆè®­ç»ƒæ–¹æ¡ˆå¹¶ä¸‹è½½
- [ ] ç¡®è®¤åŸå§‹æ–‡ä»¶å¤¹å·²åˆ é™¤
- [ ] æ£€æŸ¥æ—¥å¿—è®°å½•æ˜¯å¦æ­£å¸¸
- [ ] éªŒè¯é”™è¯¯å¤„ç†æœºåˆ¶

### å›æ»šæ–¹æ¡ˆ
```python
# å¦‚éœ€å›æ»šï¼Œæ³¨é‡Šæ‰æ¸…ç†ä»£ç 
# try:
#     if folder_path and os.path.exists(folder_path):
#         shutil.rmtree(folder_path)
#         current_app.logger.info(f"å·²åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹: {folder_path}")
# except Exception as delete_error:
#     current_app.logger.warning(f"åˆ é™¤è®­ç»ƒæ–¹æ¡ˆæ–‡ä»¶å¤¹å¤±è´¥: {folder_path}")
```

---

## ğŸ“š **ç›¸å…³æ–‡æ¡£**

- [BUG_FIX_SUMMARY.md](./BUG_FIX_SUMMARY.md) - è¯¦ç»†çš„é—®é¢˜ä¿®å¤è®°å½•
- [README.md](./README.md) - é¡¹ç›®æ€»ä½“ä»‹ç»å’ŒåŠŸèƒ½ç‰¹æ€§
- [ENVIRONMENT.md](./ENVIRONMENT.md) - ç¯å¢ƒé…ç½®å’Œéƒ¨ç½²æŒ‡å—
- [config.py](./config.py) - ç³»ç»Ÿé…ç½®æ–‡ä»¶

---

*ğŸ’¡ **æ ¸å¿ƒç†å¿µ**ï¼šåœ¨äº‘æœåŠ¡å™¨ç¯å¢ƒä¸­ï¼Œä¸´æ—¶æ–‡ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æ˜¯ç³»ç»Ÿç¨³å®šè¿è¡Œçš„å…³é”®ï¼Œé€šè¿‡æ™ºèƒ½çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶ï¼Œå¯ä»¥åœ¨ä¿è¯åŠŸèƒ½å®Œæ•´æ€§çš„å‰æä¸‹ï¼Œå®ç°èµ„æºçš„é«˜æ•ˆåˆ©ç”¨ã€‚* 